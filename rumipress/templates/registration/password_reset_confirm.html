{% extends "base.html" %}
{% block title %}Set New Password{% endblock %}
{% block extra_head %}
<style>
  body { padding-top: 0; }
  .auth-bg { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
  .auth-card { border: none; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; }
  .brand { font-weight: 700; letter-spacing: .5px; }
  .form-floating > label { color: #6c757d; }
  .form-control:focus { box-shadow: 0 0 0 .2rem rgba(13,110,253,.15); }
  .strength { height: 6px; border-radius: 4px; background: #e9ecef; overflow: hidden; }
  .strength-bar { height: 100%; width: 0; transition: width .2s ease; }
</style>
{% endblock %}
{% block navbar %}{% endblock %}
{% block content %}
<div class="auth-bg">
  <div class="container">
    <div class="row g-0 justify-content-center">
      <div class="col-md-10 col-lg-8">
        <div class="card auth-card">
          <div class="row g-0">
            <div class="col-md-6 p-4 p-md-5">
              <div class="d-flex align-items-center mb-3">
                <span class="brand h4 mb-0">Rumi Press</span>
              </div>
              {% if validlink %}
                <h2 class="h4 mb-2">Set a new password</h2>
                <p class="text-muted mb-4">Use a strong password to keep your account secure.</p>
                <form method="post" novalidate>
                  {% csrf_token %}
                  <div class="form-floating mb-3">
                    <input type="password" name="new_password1" id="id_new_password1" class="form-control{% if form.new_password1.errors %} is-invalid{% endif %}" placeholder="New password" required autocomplete="new-password" />
                    <label for="id_new_password1">New password</label>
                    {% if form.new_password1.errors %}
                      <div class="invalid-feedback">{{ form.new_password1.errors|first }}</div>
                    {% endif %}
                  </div>
                  <div class="strength mb-3"><div id="strengthBar" class="strength-bar"></div></div>
                  <div class="form-floating mb-3">
                    <input type="password" name="new_password2" id="id_new_password2" class="form-control{% if form.new_password2.errors %} is-invalid{% endif %}" placeholder="Confirm new password" required autocomplete="new-password" />
                    <label for="id_new_password2">Confirm new password</label>
                    {% if form.new_password2.errors %}
                      <div class="invalid-feedback">{{ form.new_password2.errors|first }}</div>
                    {% endif %}
                  </div>
                  <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">Change Password</button>
                  </div>
                  <div class="d-flex justify-content-end mt-3">
                    <a class="text-decoration-none" href="{% url 'login' %}">Back to login</a>
                  </div>
                </form>
              {% else %}
                <h2 class="h4 mb-2">Invalid reset link</h2>
                <p class="text-muted">The link is invalid or has expired. Request a new one.</p>
                <div class="d-grid d-sm-flex gap-2 mt-3">
                  <a href="{% url 'password_reset' %}" class="btn btn-primary">Request New Link</a>
                  <a href="{% url 'login' %}" class="btn btn-outline-secondary">Back to Login</a>
                </div>
              {% endif %}
            </div>
            <div class="col-md-6 d-none d-md-block p-4 p-md-5" style="background: linear-gradient(135deg, rgba(13,110,253,0.9), rgba(99,102,241,0.9)); color: #fff;">
              <div class="h-100 d-flex flex-column justify-content-center">
                <h4 class="mb-3">Stay secure</h4>
                <p class="mb-0">Use a mix of upper/lowercase, digits, and symbols.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  (function(){
    const p1 = document.getElementById('id_new_password1');
    const bar = document.getElementById('strengthBar');
    function score(v){
      let s = 0;
      if (!v) return 0;
      if (v.length >= 8) s++;
      if (v.length >= 12) s++;
      if (/[A-Z]/.test(v)) s++;
      if (/[a-z]/.test(v)) s++;
      if (/\d/.test(v)) s++;
      if (/[^A-Za-z0-9]/.test(v)) s++;
      return Math.min(s, 6);
    }
    function update(){
      const s = score(p1?.value || '');
      const pct = (s/6)*100;
      bar.style.width = pct + '%';
      bar.style.background = pct < 50 ? '#dc3545' : (pct < 80 ? '#ffc107' : '#28a745');
    }
    p1 && p1.addEventListener('input', update);
    update();
  })();
</script>
{% endblock %}