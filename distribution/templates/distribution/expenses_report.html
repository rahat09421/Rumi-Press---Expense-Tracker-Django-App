{% extends "base.html" %}
{% block title %}Expense Report -- Rumi Press{% endblock  %}
{% block extra_head %}
    <style>
        .chart-wrap{
            height: 420px;
        }
    </style>
{% endblock %}


{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3 rp-page-header">
    <h2 class="mb-0">Distribution Expenses by Category</h2>
    <form id="reportFilters" class="d-flex flex-wrap align-items-center gap-2">
      <label class="form-label d-flex align-items-center gap-2 mb-0">
        <span>From</span>
        <input id="start" type="date" class="form-control form-control-sm">
      </label>
      <label class="form-label d-flex align-items-center gap-2 mb-0">
        <span>To</span>
        <input id="end" type="date" class="form-control form-control-sm">
      </label>
      <button id="filterBtn" type="button" class="btn btn-primary btn-sm">Filter</button>
      <button id="clearBtn" type="button" class="btn btn-outline-secondary btn-sm">Clear</button>
    </form>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <div class="chart-wrap mb-4">
        <canvas id="expensesChart"></canvas>
      </div>
      <div class="table-responsive rp-table-wrap">
        <table class="table table-striped table-hover align-middle rp-table">
          <thead>
            <tr>
              <th>Category</th>
              <th class="text-end">Total Expense</th>
            </tr>
          </thead>
          <tbody id="reportsRows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock  %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const apiUrl = "{% url 'distribution:expenses_by_category_json' %}";

    let chart = null;
    function fetchAndRender(start, end) {
        const url = new URL(apiUrl, window.location.origin);
        if (start) url.searchParams.set('start_date', start);
        if (end) url.searchParams.set('end_date', end);
        fetch(url).then(r => r.json()).then(data => {
            const labels = data.map(d => d.category);
            const totals = data.map(d => d.total);

            const tbody = document.getElementById('reportsRows');
            tbody.innerHTML = '';
            data.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${d.category}</td><td class="text-end">$${Number(d.total).toFixed(2)}</td>`;
                tbody.appendChild(tr);
            });

            const ctx = document.getElementById('expensesChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Distribution Expense', data: totals }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            }); 
        });
    }

    document.getElementById('filterBtn').addEventListener('click', () => {
        const s = document.getElementById('start').value;
        const e = document.getElementById('end').value;
        fetchAndRender(s, e);
    });
    document.getElementById('clearBtn').addEventListener('click', () =>{
        document.getElementById('start').value = '';
        document.getElementById('end').value = '';
        fetchAndRender();
    });

    fetchAndRender();
</script>
{% endblock %}