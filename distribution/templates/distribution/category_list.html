{% extends "base.html" %}
{% block title %}Categories — Rumi Press{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3 rp-page-header">
    <h2 class="mb-0">Categories List</h2>
    <div class="d-flex flex-wrap align-items-end gap-2">
      <a href="{% url 'distribution:book_list' %}" class="btn btn-outline-secondary me-2">Books</a>
      <a href="{% url 'distribution:category_add' %}" class="btn btn-success">Add Category</a>
      <form id="catFiltersForm" method="get" class="d-flex align-items-center gap-2 mb-0">
        <input type="text" name="q" value="{{ filters.q }}" class="form-control form-control-sm" placeholder="Search category name" />
        <button id="catClearFilters" class="btn btn-outline-secondary btn-sm" type="button">Clear</button>
      </form>
    </div>
  </div>

  <!-- Bulk delete form -->
  <form id="catBulkForm" method="post" action="{% url 'distribution:category_bulk_delete' %}" class="mb-2">
    {% csrf_token %}
    {% if querystring %}<input type="hidden" name="next" value="{{ querystring }}" />{% endif %}
    {% if is_paginated %}<div id="pageStatus" class="text-muted mb-2">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }} — showing 20 per page</div>{% endif %}
    <button id="catBulkDeleteBtn" class="btn btn-danger d-none mb-2" type="button" disabled>Delete Selected</button>

    <!-- Confirm bulk delete modal -->
    <div class="modal fade" id="catBulkConfirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Delete selected category(ies) (<span id="catSelectedCount">0</span>)? Categories with related books will be skipped.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="catConfirmBulkDeleteBtn">Yes, Delete</button>
          </div>
        </div>
      </div>
    </div>

  <div class="table-responsive rp-table-wrap">
    <div id="catsLoadingOverlay" class="rp-loading"><div class="spinner"></div></div>
    <table class="table table-striped table-hover align-middle rp-table">
      <thead class="table-light" id="catsHead" data-sort="{{ sort }}" data-dir="{{ dir }}">
        <tr>
          <th style="width:36px;"><input type="checkbox" id="selectAllCats" /></th>
          <th>
            <a href="?sort=name&dir={% if sort == 'name' and dir == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link text-decoration-none text-reset">
              Name
              {% if sort == 'name' %}<span class="sort-ind">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}
            </a>
          </th>
          <th class="text-center">
            <a href="?sort=books_count&dir={% if sort == 'books_count' and dir == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link text-decoration-none text-reset">
              Books
              {% if sort == 'books_count' %}<span class="sort-ind">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}
            </a>
          </th>
          <th class="text-end">
            <a href="?sort=total_expense&dir={% if sort == 'total_expense' and dir == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link text-decoration-none text-reset">
              Total Distribution Expense
              {% if sort == 'total_expense' %}<span class="sort-ind">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}
            </a>
          </th>
        </tr>
      </thead>
      <tbody id="catsRows">
        {% for cat in categories %}
        <tr>
          <td><input type="checkbox" name="selected" value="{{ cat.pk }}" class="row-check" /></td>
          <td>
            <a href="{% url 'distribution:category_edit' cat.pk %}" class="text-decoration-none text-reset">{{ cat.name }}</a>
          </td>
          <td class="text-center">{{ cat.books_count }}</td>
          <td class="text-end">$ {{ cat.total_expense|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center text-muted">No categories found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  </form>

  <!-- Pager -->
  <div id="catsPager">
    {% if is_paginated %}
    <nav aria-label="Categories pagination">
      <ul class="pagination justify-content-center">
        {% with total=page_obj.paginator.num_pages current=page_obj.number %}
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Previous</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if num <= 5 %}
              {% if num == current %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if querystring %}&{{ querystring }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if current|add:"-2" > 6 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if num >= 6 and num <= total|add:"-1" and num >= current|add:"-2" and num <= current|add:"2" %}
              {% if num == current %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if querystring %}&{{ querystring }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if current|add:"2" < total|add:"-1" %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}

          {% if total > 5 %}
            {% if current == total %}
              <li class="page-item active"><span class="page-link">{{ total }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ total }}{% if querystring %}&{{ querystring }}{% endif %}">{{ total }}</a></li>
            {% endif %}
          {% endif %}

          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Next</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        {% endwith %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>

<script>
  // Live filtering + bulk selection for categories (similar to books)
  const cForm = document.getElementById('catFiltersForm');
  const cInputQ = cForm?.querySelector('input[name="q"]');
  const cClearBtn = document.getElementById('catClearFilters');

  function catAttachBulkHandlers() {
    const selectAll = document.getElementById('selectAllCats');
    const btn = document.getElementById('catBulkDeleteBtn');
    const bulkForm = document.getElementById('catBulkForm');
    const rowsWrap = document.getElementById('catsRows');
    function updateBtn() {
      const any = Array.from(document.querySelectorAll('.row-check')).some(c => c.checked);
      if (!btn) return;
      btn.disabled = !any;
      btn.classList.toggle('d-none', !any);
    }
    if (selectAll && !selectAll.dataset.bound) {
      selectAll.dataset.bound = '1';
      selectAll.addEventListener('change', (e) => {
        const on = e.target.checked;
        document.querySelectorAll('.row-check').forEach(c => {
          c.checked = on;
          c.closest('tr')?.classList.toggle('selected', on);
        });
        updateBtn();
      });
    }
    if (rowsWrap && !rowsWrap.dataset.bound) {
      rowsWrap.dataset.bound = '1';
      rowsWrap.addEventListener('change', (e) => {
        const t = e.target;
        if (t && t.classList && t.classList.contains('row-check')) {
          t.closest('tr')?.classList.toggle('selected', t.checked);
          updateBtn();
        }
      });
    }
    document.querySelectorAll('.row-check').forEach(c => c.closest('tr')?.classList.toggle('selected', c.checked));
    updateBtn();

    const modalEl = document.getElementById('catBulkConfirmModal');
    const confirmBtn = document.getElementById('catConfirmBulkDeleteBtn');
    if (btn && !btn.dataset.modalBound) {
      btn.dataset.modalBound = '1';
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        if (btn.disabled) return;
        const cntEl = document.getElementById('catSelectedCount');
        const cnt = document.querySelectorAll('.row-check:checked').length;
        if (cntEl) cntEl.textContent = String(cnt);
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      });
    }
    if (confirmBtn && !confirmBtn.dataset.bound) {
      confirmBtn.dataset.bound = '1';
      confirmBtn.addEventListener('click', () => {
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.hide();
        bulkForm.submit();
      });
    }
  }

  function catAttachPagerHandlers() {
    const pager = document.getElementById('catsPager');
    pager?.querySelectorAll('a.page-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const url = new URL(a.href);
        const page = url.searchParams.get('page') || '1';
        catApplyFilters({ page });
      });
    });
  }

  function catAttachSortHandlers() {
    const head = document.getElementById('catsHead');
    head?.querySelectorAll('a.sort-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const url = new URL(a.href, window.location.origin);
        const sort = url.searchParams.get('sort') || a.dataset.sort;
        const dir = url.searchParams.get('dir') || a.dataset.dir || 'asc';
        catApplyFilters({ sort, dir, page: 1 });
      });
    });
  }

  function catCurrentParams(extra={}) {
    const params = new URLSearchParams();
    if (cInputQ?.value) params.set('q', cInputQ.value);
    const headEl = document.getElementById('catsHead');
    const sort = extra.sort ?? headEl?.dataset.sort;
    const dir = extra.dir ?? headEl?.dataset.dir;
    if (sort) params.set('sort', sort);
    if (dir) params.set('dir', dir);
    if (extra.page) params.set('page', extra.page);
    return params;
  }

  async function catApplyFilters(extra={}) {
    const overlay = document.getElementById('catsLoadingOverlay');
    const params = catCurrentParams(extra);
    const url = `${window.location.pathname}?${params.toString()}`;

    const nextInput = document.querySelector('#catBulkForm input[name="next"]');
    if (nextInput) nextInput.value = params.toString();

    overlay && (overlay.style.display = 'flex');
    try {
      const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');

      const newRows = doc.querySelector('#catsRows');
      const newPager = doc.querySelector('#catsPager');
      const newStatus = doc.querySelector('#pageStatus');
      const newHead = doc.querySelector('#catsHead');

      const rowsEl = document.querySelector('#catsRows');
      const pagerEl = document.querySelector('#catsPager');
      const statusEl = document.querySelector('#pageStatus');
      const headElLocal = document.querySelector('#catsHead');

      if (rowsEl && newRows) rowsEl.innerHTML = newRows.innerHTML;
      if (pagerEl && newPager) pagerEl.innerHTML = newPager.innerHTML;
      if (statusEl && newStatus) statusEl.innerHTML = newStatus.innerHTML;
      if (headElLocal && newHead) {
        headElLocal.dataset.sort = newHead.dataset.sort;
        headElLocal.dataset.dir = newHead.dataset.dir;
        headElLocal.innerHTML = newHead.innerHTML;
      }

      catAttachPagerHandlers();
      catAttachBulkHandlers();
      catAttachSortHandlers();
    } finally {
      overlay && (overlay.style.display = 'none');
    }
  }

  // Debounced search typing
  let typingTimer;
  cInputQ?.addEventListener('input', () => {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => catApplyFilters(), 350);
  });

  // Clear filters button
  cClearBtn?.addEventListener('click', () => {
    if (!cForm) return;
    if (cInputQ) cInputQ.value = '';
    catApplyFilters({ page: 1 });
  });

  // Initial attach
  catAttachPagerHandlers();
  catAttachBulkHandlers();
  catAttachSortHandlers();
</script>
{% endblock %}
