{% extends "base.html" %}
{% block title %}Book List - Rumi Press{% endblock title %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3 rp-page-header">
    <h2 class="mb-0">Books List</h2>
    <div class="d-flex flex-wrap align-items-end gap-2">
      <a class="btn btn-success" href="{% url 'distribution:book_add' %}">Add New Book</a>
      {% if user.is_staff %}
        <a class="btn btn-outline-primary" href="{% url 'distribution:import_books' %}">Import</a>
      {% endif %}
      <form id="filtersForm" method="get" class="d-flex align-items-center gap-2 mb-0">
        <input type="text" name="q" value="{{ filters.q }}" class="form-control form-control-sm" placeholder="Search title, author, publisher" />
        <select name="category" class="form-select form-select-sm">
          <option value="">All Categories</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {% if filters.category == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name|title }}</option>
          {% endfor %}
        </select>
        <input type="date" name="start" value="{{ filters.start }}" class="form-control form-control-sm" />
        <input type="date" name="end" value="{{ filters.end }}" class="form-control form-control-sm" />
        <button id="clearFilters" class="btn btn-outline-secondary btn-sm" type="button">Clear</button>
      </form>
    </div>
  </div>

  <!-- Bulk delete form -->
  <form id="bulkForm" method="post" action="{% url 'distribution:book_bulk_delete' %}" class="mb-2">
    {% csrf_token %}
    {% if querystring %}<input type="hidden" name="next" value="{{ querystring }}" />{% endif %}
    <div class="d-flex justify-content-between align-items-center mb-2 rp-toolbar">
      <div id="pageStatus" class="text-muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }} — showing 20 per page</div>
      <button id="bulkDeleteBtn" class="btn btn-danger d-none" type="button" disabled>Delete Selected</button>
    </div>
    
    <!-- Confirm bulk delete modal -->
    <div class="modal fade" id="bulkConfirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirm Delete</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Delete selected book(s) (<span id="selectedCount">0</span>)? This action cannot be undone.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">Yes, Delete</button>
          </div>
        </div>
      </div>
    </div>

    <div class="table-responsive rp-table-wrap">
      <div id="loadingOverlay" class="rp-loading"><div class="spinner"></div></div>
      <table class="table table-striped table-hover align-middle rp-table">
        <thead class="table-light" id="booksHead" data-sort="{{ sort }}" data-dir="{{ dir }}">
        <tr>
          <th style="width:36px;"><input type="checkbox" id="selectAll" /></th>
          <th>
            <a href="?sort=title&dir={% if sort == 'title' and dir == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link text-decoration-none text-reset">
              Title
              {% if sort == 'title' %}<span class="sort-ind">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}
            </a>
          </th>
          <th>
            <a href="?sort=author&dir={% if sort == 'author' and dir == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link text-decoration-none text-reset">
              Author
              {% if sort == 'author' %}<span class="sort-ind">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}
            </a>
          </th>
          <th>
            <a href="?sort=publisher&dir={% if sort == 'publisher' and dir == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link text-decoration-none text-reset">
              Publisher
              {% if sort == 'publisher' %}<span class="sort-ind">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}
            </a>
          </th>
          <th>
            <a href="?sort=category&dir={% if sort == 'category' and dir == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link text-decoration-none text-reset">
              Category
              {% if sort == 'category' %}<span class="sort-ind">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}
            </a>
          </th>
          <th class="text-end">
            <a href="?sort=distribution_expenses&dir={% if sort == 'distribution_expenses' and dir == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link text-decoration-none text-reset">
              Distribution Expenses
              {% if sort == 'distribution_expenses' %}<span class="sort-ind">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}
            </a>
          </th>
        </tr>
      </thead>
      <tbody id="booksRows">
        {% for book in books %}
        <tr>
          <td><input type="checkbox" name="selected" value="{{ book.pk }}" class="row-check" /></td>
          <td>
            <a href="{% url 'distribution:book_edit' book.pk %}" class="text-decoration-none text-reset">{{ book.title }}</a>
          </td>
          <td>{{ book.author }}</td>
          <td>{{ book.publisher }}</td>
          <td>{{ book.category.name|title }}</td>
          <td class="text-end">{{ book.distribution_expenses|floatformat:2 }}$</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">No books found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </form>

  <!-- Pager -->
  <div id="booksPager">
    {% if is_paginated %}
    <nav aria-label="Books pagination">
      <ul class="pagination justify-content-center">
        {% with total=page_obj.paginator.num_pages current=page_obj.number %}
          {# Previous #}
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Previous</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
          {% endif %}

          {# First group: 1–5 #}
          {% for num in page_obj.paginator.page_range %}
            {% if num <= 5 %}
              {% if num == current %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if querystring %}&{{ querystring }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endif %}
          {% endfor %}

          {# Left ellipsis if there is a gap between first group and middle #}
          {% if current|add:"-2" > 6 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}

          {# Middle group around current (clamped 6..total-1) #}
          {% for num in page_obj.paginator.page_range %}
            {% if num >= 6 and num <= total|add:"-1" and num >= current|add:"-2" and num <= current|add:"2" %}
              {% if num == current %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% if querystring %}&{{ querystring }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endif %}
          {% endfor %}

          {# Right ellipsis if middle group doesn't reach last page #}
          {% if current|add:"2" < total|add:"-1" %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}

          {# Always show last page if total > 5 #}
          {% if total > 5 %}
            {% if current == total %}
              <li class="page-item active"><span class="page-link">{{ total }}</span></li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ total }}{% if querystring %}&{{ querystring }}{% endif %}">{{ total }}</a></li>
            {% endif %}
          {% endif %}

          {# Next #}
          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}">Next</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
          {% endif %}
        {% endwith %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Live filtering + bulk selection without page reload
  const form = document.getElementById('filtersForm');
  const inputQ = form?.querySelector('input[name="q"]');
  const selectCat = form?.querySelector('select[name="category"]');
  const inputStart = form?.querySelector('input[name="start"]');
  const inputEnd = form?.querySelector('input[name="end"]');
  const clearBtn = document.getElementById('clearFilters');
  const headEl = document.getElementById('booksHead');

  function attachBulkHandlers() {
    const selectAll = document.getElementById('selectAll');
    const btn = document.getElementById('bulkDeleteBtn');
    const bulkForm = document.getElementById('bulkForm');
    const rowsWrap = document.getElementById('booksRows');
    function updateBtn() {
      const any = Array.from(document.querySelectorAll('.row-check')).some(c => c.checked);
      if (!btn) return;
      btn.disabled = !any;
      btn.classList.toggle('d-none', !any);
    }
    // Bind select-all only once
    if (selectAll && !selectAll.dataset.bound) {
      selectAll.dataset.bound = '1';
      selectAll.addEventListener('change', (e) => {
        const on = e.target.checked;
        document.querySelectorAll('.row-check').forEach(c => {
          c.checked = on;
          c.closest('tr')?.classList.toggle('selected', on);
        });
        updateBtn();
      });
    }
    // Delegate row checkbox changes to table body (bind once)
    if (rowsWrap && !rowsWrap.dataset.bound) {
      rowsWrap.dataset.bound = '1';
      rowsWrap.addEventListener('change', (e) => {
        const t = e.target;
        if (t && t.classList && t.classList.contains('row-check')) {
          t.closest('tr')?.classList.toggle('selected', t.checked);
          updateBtn();
        }
      });
    }
    // initialize selected row highlight
    document.querySelectorAll('.row-check').forEach(c => c.closest('tr')?.classList.toggle('selected', c.checked));
    updateBtn();

    // Bind modal-based delete confirmation once
    const modalEl = document.getElementById('bulkConfirmModal');
    const confirmBtn = document.getElementById('confirmBulkDeleteBtn');
    if (btn && !btn.dataset.modalBound) {
      btn.dataset.modalBound = '1';
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        if (btn.disabled) return;
        const cntEl = document.getElementById('selectedCount');
        const cnt = document.querySelectorAll('.row-check:checked').length;
        if (cntEl) cntEl.textContent = String(cnt);
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      });
    }
    if (confirmBtn && !confirmBtn.dataset.bound) {
      confirmBtn.dataset.bound = '1';
      confirmBtn.addEventListener('click', () => {
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.hide();
        bulkForm.submit();
      });
    }
  }

  function attachPagerHandlers() {
    const pager = document.getElementById('booksPager');
    pager?.querySelectorAll('a.page-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const url = new URL(a.href);
        const page = url.searchParams.get('page') || '1';
        applyFilters({ page });
      });
    });
  }

  function attachSortHandlers() {
    const head = document.getElementById('booksHead');
    head?.querySelectorAll('a.sort-link').forEach(a => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        const url = new URL(a.href, window.location.origin);
        const sort = url.searchParams.get('sort') || a.dataset.sort;
        const dir = url.searchParams.get('dir') || a.dataset.dir || 'asc';
        applyFilters({ sort, dir, page: 1 });
      });
    });
  }

  function currentParams(extra={}) {
    const params = new URLSearchParams();
    if (inputQ?.value) params.set('q', inputQ.value);
    if (selectCat?.value) params.set('category', selectCat.value);
    if (inputStart?.value) params.set('start', inputStart.value);
    if (inputEnd?.value) params.set('end', inputEnd.value);
    const sort = extra.sort ?? headEl?.dataset.sort;
    const dir = extra.dir ?? headEl?.dataset.dir;
    if (sort) params.set('sort', sort);
    if (dir) params.set('dir', dir);
    if (extra.page) params.set('page', extra.page);
    return params;
  }

  async function applyFilters(extra={}) {
    const overlay = document.getElementById('loadingOverlay');
    const params = currentParams(extra);
    const url = `${window.location.pathname}?${params.toString()}`;

    // Keep next param in bulk delete form up to date
    const nextInput = document.querySelector('#bulkForm input[name="next"]');
    if (nextInput) nextInput.value = params.toString();

    overlay && (overlay.style.display = 'flex');
    try {
      const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');

      const newRows = doc.querySelector('#booksRows');
      const newPager = doc.querySelector('#booksPager');
      const newStatus = doc.querySelector('#pageStatus');
      const newHead = doc.querySelector('#booksHead');

      const rowsEl = document.querySelector('#booksRows');
      const pagerEl = document.querySelector('#booksPager');
      const statusEl = document.querySelector('#pageStatus');
      const headElLocal = document.querySelector('#booksHead');

      if (rowsEl && newRows) rowsEl.innerHTML = newRows.innerHTML;
      if (pagerEl && newPager) pagerEl.innerHTML = newPager.innerHTML;
      if (statusEl && newStatus) statusEl.innerHTML = newStatus.innerHTML;
      if (headElLocal && newHead) {
        headElLocal.dataset.sort = newHead.dataset.sort;
        headElLocal.dataset.dir = newHead.dataset.dir;
        headElLocal.innerHTML = newHead.innerHTML;
      }

      attachPagerHandlers();
      attachBulkHandlers();
      attachSortHandlers();
    } finally {
      overlay && (overlay.style.display = 'none');
    }
  }

  // Debounced search typing (keeps focus)
  let typingTimer;
  inputQ?.addEventListener('input', () => {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => applyFilters(), 350);
  });

  // Category and date change triggers
  [selectCat, inputStart, inputEnd].forEach(el => el?.addEventListener('change', () => applyFilters()));

  // Clear filters button
  clearBtn?.addEventListener('click', () => {
    if (!form) return;
    if (inputQ) inputQ.value = '';
    if (selectCat) selectCat.value = '';
    if (inputStart) inputStart.value = '';
    if (inputEnd) inputEnd.value = '';
    applyFilters({ page: 1 });
  });

  // Initial attach
  attachPagerHandlers();
  attachBulkHandlers();
  attachSortHandlers();
</script>
{% endblock %}
